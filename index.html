<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayesian A/B Test Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .tab-nav {
            background: #f8f9fa;
            padding: 0;
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .advanced-options {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .advanced-toggle {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 15px;
        }
        
        .advanced-inputs {
            display: none;
        }
        
        .advanced-inputs.show {
            display: block;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .calculate-btn {
            width: 100%;
            margin-top: 20px;
        }
        
        .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #28a745;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .metric-small {
            font-size: 18px;
        }
        
        .positive {
            color: #28a745;
        }
        
        .negative {
            color: #dc3545;
        }
        
        .sample-size-section {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #ffc107;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .history-table th,
        .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .history-table tr:hover {
            background: #f8f9fa;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .progress-chart {
            width: 100%;
            height: 300px;
        }
        
        .sync-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .supabase-setup {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        
        .supabase-setup input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-nav {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bayesian A/B Test Calculator</h1>
            <p>Statistical analysis with progress tracking and sample size estimation</p>
        </div>
        
        <div class="tab-nav">
            <button class="tab-btn active" id="calculator-tab">Calculator</button>
            <button class="tab-btn" id="history-tab">Test History</button>
            <button class="tab-btn" id="progress-tab">Progress Tracking</button>
        </div>
        
        <!-- Calculator Tab -->
        <div id="calculator" class="tab-content active">
            <div class="main-content">
                <div class="input-section">
                    <h3>Test Data</h3>
                    
                    <div class="input-group">
                        <label>Test Name</label>
                        <input type="text" id="test-name" placeholder="Enter test name (optional)" value="">
                    </div>
                    
                    <div class="input-group">
                        <label>Group A (Control)</label>
                        <div class="input-row">
                            <div>
                                <input type="number" id="a-successes" placeholder="Successes" value="248" min="0">
                                <small>Successes</small>
                            </div>
                            <div>
                                <input type="number" id="a-total" placeholder="Total" value="293" min="1">
                                <small>Total trials</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Group B (Variant)</label>
                        <div class="input-row">
                            <div>
                                <input type="number" id="b-successes" placeholder="Successes" value="271" min="0">
                                <small>Successes</small>
                            </div>
                            <div>
                                <input type="number" id="b-total" placeholder="Total" value="299" min="1">
                                <small>Total trials</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="advanced-options">
                        <button class="advanced-toggle" onclick="toggleAdvanced()">Advanced Options</button>
                        <div class="advanced-inputs" id="advanced-inputs">
                            <div class="input-group">
                                <label>Simulation Settings</label>
                                <div class="input-row">
                                    <div>
                                        <input type="number" id="n-simulations" placeholder="100000" value="100000" min="1000">
                                        <small>Simulations</small>
                                    </div>
                                    <div>
                                        <input type="number" id="target-width" placeholder="5.0" value="5.0" min="0.1" step="0.1">
                                        <small>Target CI width (%)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="input-group">
                                <label>Beta Prior Parameters</label>
                                <div class="input-row">
                                    <div>
                                        <input type="number" id="alpha-prior" placeholder="1" value="1" min="0.1" step="0.1">
                                        <small>Alpha</small>
                                    </div>
                                    <div>
                                        <input type="number" id="beta-prior" placeholder="1" value="1" min="0.1" step="0.1">
                                        <small>Beta</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary calculate-btn" onclick="runCalculation()">Run Bayesian Analysis</button>
                    <button class="btn btn-success calculate-btn" onclick="saveResult()">Save Result to History</button>
                    
                    <div id="sync-status" class="sync-status" style="display: none;"></div>
                </div>
                
                <div class="results-section">
                    <h3>Results</h3>
                    <div id="results-content">
                        <p class="loading">Enter your test data and click "Run Bayesian Analysis" to see results.</p>
                    </div>
                </div>
                
                <div class="sample-size-section" id="sample-size-section" style="display: none;">
                    <h3>Sample Size Recommendation</h3>
                    <div id="sample-size-content"></div>
                </div>
            </div>
        </div>
        
        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Test History</h3>
                <div>
                    <button class="btn btn-secondary" onclick="setupSupabase()">Setup Supabase Sync</button>
                    <button class="btn btn-secondary" onclick="syncWithSupabase()">Sync with Supabase</button>
                    <button class="btn btn-secondary" onclick="exportResults()">Export CSV</button>
                    <button class="btn btn-danger" onclick="clearHistory()">Clear All</button>
                </div>
            </div>
            
            <div id="supabase-setup" class="supabase-setup" style="display: none;">
                <h4>Supabase Setup</h4>
                <p>To enable cross-device sync, enter your Supabase credentials below:</p>
                <input type="text" id="supabase-url" placeholder="Enter Supabase URL (e.g., https://your-project.supabase.co)" />
                <input type="password" id="supabase-anon-key" placeholder="Enter Supabase Anonymous Key" />
                <button class="btn btn-primary" onclick="saveSupabaseConfig()">Save Configuration</button>
            </div>
            
            <div id="history-content">
                <p class="loading">No saved results yet. Run calculations and save them to build your test history.</p>
            </div>
        </div>
        
        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <h3>Progress Tracking</h3>
            <div style="margin-bottom: 20px;">
                <label>Select Test to Track:</label>
                <select id="test-selector" onchange="updateProgressChart()" style="margin-left: 10px; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                    <option value="">Select a test...</option>
                </select>
            </div>
            
            <div class="chart-container">
                <canvas id="progress-chart" class="progress-chart"></canvas>
            </div>
            
            <div id="progress-stats" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let currentResults = null;
        let progressChart = null;
        let lastInputData = null;
        let supabase = null;
        let supabaseConfig = null;
        
        // Load configuration on page load
        window.addEventListener('DOMContentLoaded', function() {
            loadSupabaseConfig();
            loadLastInputData();
            loadLastResults();
        });
        
        // Save input data whenever user changes values
        function setupInputListeners() {
            const inputs = ['a-successes', 'a-total', 'b-successes', 'b-total', 'n-simulations', 'target-width', 'alpha-prior', 'beta-prior'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveInputData);
                    element.addEventListener('blur', saveInputData);
                }
            });
        }
        
        function saveInputData() {
            const inputData = {
                aSuccesses: document.getElementById('a-successes').value,
                aTotal: document.getElementById('a-total').value,
                bSuccesses: document.getElementById('b-successes').value,
                bTotal: document.getElementById('b-total').value,
                nSimulations: document.getElementById('n-simulations').value,
                targetWidth: document.getElementById('target-width').value,
                alphaPrior: document.getElementById('alpha-prior').value,
                betaPrior: document.getElementById('beta-prior').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('abTestLastInput', JSON.stringify(inputData));
            } catch (e) {
                console.log('Could not save input data to localStorage');
            }
        }
        
        function loadLastInputData() {
            try {
                const savedData = JSON.parse(localStorage.getItem('abTestLastInput') || 'null');
                if (savedData) {
                    document.getElementById('a-successes').value = savedData.aSuccesses;
                    document.getElementById('a-total').value = savedData.aTotal;
                    document.getElementById('b-successes').value = savedData.bSuccesses;
                    document.getElementById('b-total').value = savedData.bTotal;
                    document.getElementById('n-simulations').value = savedData.nSimulations;
                    document.getElementById('target-width').value = savedData.targetWidth;
                    document.getElementById('alpha-prior').value = savedData.alphaPrior;
                    document.getElementById('beta-prior').value = savedData.betaPrior;
                }
            } catch (e) {
                console.log('Could not load last input data');
            }
            
            setupInputListeners();
        }
        
        // Local storage management
        function saveToStorage(key, data) {
            try {
                const stored = JSON.parse(localStorage.getItem(key) || '[]');
                stored.push(data);
                localStorage.setItem(key, JSON.stringify(stored));
                return true;
            } catch (error) {
                console.error('Storage not available, using in-memory storage');
                return false;
            }
        }
        
        function getFromStorage(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || '[]');
            } catch (error) {
                console.error('Storage not available');
                return [];
            }
        }
        
        function clearStorage(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error('Storage not available');
                return false;
            }
        }
        
        // Tab switching
        async function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update content based on tab
            if (tabName === 'history') {
                await loadHistory();
            } else if (tabName === 'progress') {
                loadProgressTracking();
            }
        }
        
        // Utility function to generate random samples from Beta distribution
        function betaRandom(alpha, beta) {
            const gammaA = gammaRandom(alpha, 1);
            const gammaB = gammaRandom(beta, 1);
            return gammaA / (gammaA + gammaB);
        }
        
        function gammaRandom(shape, scale) {
            if (shape < 1) {
                return gammaRandom(shape + 1, scale) * Math.pow(Math.random(), 1 / shape);
            }
            
            const d = shape - 1/3;
            const c = 1 / Math.sqrt(9 * d);
            
            while (true) {
                let x, v;
                do {
                    x = normalRandom();
                    v = 1 + c * x;
                } while (v <= 0);
                
                v = v * v * v;
                const u = Math.random();
                
                if (u < 1 - 0.0331 * x * x * x * x) {
                    return d * v * scale;
                }
                
                if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) {
                    return d * v * scale;
                }
            }
        }
        
        let normalRandomSpare = null;
        function normalRandom() {
            if (normalRandomSpare !== null) {
                const tmp = normalRandomSpare;
                normalRandomSpare = null;
                return tmp;
            }
            
            const u = Math.random();
            const v = Math.random();
            const mag = Math.sqrt(-2 * Math.log(u));
            normalRandomSpare = mag * Math.cos(2 * Math.PI * v);
            return mag * Math.sin(2 * Math.PI * v);
        }
        
        function runSimulation(aSuccesses, aTotal, bSuccesses, bTotal, nSimulations = 100000, alphaPrior = 1, betaPrior = 1) {
            const aAlpha = aSuccesses + alphaPrior;
            const aBeta = aTotal - aSuccesses + betaPrior;
            const bAlpha = bSuccesses + alphaPrior;
            const bBeta = bTotal - bSuccesses + betaPrior;
            
            const aSamples = [];
            const bSamples = [];
            const relativeUplift = [];
            
            for (let i = 0; i < nSimulations; i++) {
                const aSample = betaRandom(aAlpha, aBeta);
                const bSample = betaRandom(bAlpha, bBeta);
                
                aSamples.push(aSample);
                bSamples.push(bSample);
                relativeUplift.push((bSample - aSample) / aSample);
            }
            
            const meanUplift = relativeUplift.reduce((sum, val) => sum + val, 0) / nSimulations * 100;
            
            const sortedUplift = relativeUplift.map(x => x * 100).sort((a, b) => a - b);
            const ciLower = sortedUplift[Math.floor(0.025 * nSimulations)];
            const ciUpper = sortedUplift[Math.floor(0.975 * nSimulations)];
            const ciWidth = ciUpper - ciLower;
            
            const probBBetter = bSamples.filter((b, i) => b > aSamples[i]).length / nSimulations;
            
            const expectedLoss = aSamples.map((a, i) => Math.max(a - bSamples[i], 0))
                                        .reduce((sum, val) => sum + val, 0) / nSimulations;
            
            return {
                aConversion: aSuccesses / aTotal,
                bConversion: bSuccesses / bTotal,
                meanUplift: meanUplift,
                ciLower: ciLower,
                ciUpper: ciUpper,
                ciWidth: ciWidth,
                probBBetter: probBBetter,
                expectedLoss: expectedLoss,
                aSamples: aSamples,
                bSamples: bSamples
            };
        }
        
        function calculateAdditionalSampleSize(aSuccesses, aTotal, bSuccesses, bTotal, targetWidth = 5.0) {
            const aRate = aSuccesses / aTotal;
            const bRate = bSuccesses / bTotal;
            
            const initialResults = runSimulation(aSuccesses, aTotal, bSuccesses, bTotal, 50000);
            const currentWidth = initialResults.ciWidth;
            
            if (currentWidth <= targetWidth) {
                return {
                    additionalSamplesNeededA: 0,
                    additionalSamplesNeededB: 0,
                    totalSamplesA: aTotal,
                    totalSamplesB: bTotal,
                    estimatedFinalWidth: currentWidth
                };
            }
            
            const scalingFactor = Math.pow(currentWidth / targetWidth, 2);
            let additionalA = Math.ceil((scalingFactor - 1) * aTotal);
            let additionalB = Math.ceil((scalingFactor - 1) * bTotal);
            
            function testWidth(addA, addB) {
                const newASuccesses = Math.round(aRate * addA);
                const newBSuccesses = Math.round(bRate * addB);
                
                const testResults = runSimulation(
                    aSuccesses + newASuccesses,
                    aTotal + addA,
                    bSuccesses + newBSuccesses,
                    bTotal + addB,
                    25000
                );
                
                return testResults.ciWidth;
            }
            
            let lowFactor = 0.7;
            let highFactor = 1.3;
            let bestAdditionalA = additionalA;
            let bestAdditionalB = additionalB;
            let bestWidth = testWidth(additionalA, additionalB);
            
            if (bestWidth > targetWidth) {
                highFactor = 2.0;
            }
            
            for (let i = 0; i < 5; i++) {
                const midFactor = (lowFactor + highFactor) / 2;
                const midAdditionalA = Math.ceil(midFactor * additionalA);
                const midAdditionalB = Math.ceil(midFactor * additionalB);
                
                const width = testWidth(midAdditionalA, midAdditionalB);
                
                if (width < bestWidth && Math.abs(width - targetWidth) < Math.abs(bestWidth - targetWidth)) {
                    bestWidth = width;
                    bestAdditionalA = midAdditionalA;
                    bestAdditionalB = midAdditionalB;
                }
                
                if (width > targetWidth) {
                    lowFactor = midFactor;
                } else {
                    highFactor = midFactor;
                }
            }
            
            bestAdditionalA = Math.ceil(bestAdditionalA / 10) * 10;
            bestAdditionalB = Math.ceil(bestAdditionalB / 10) * 10;
            
            return {
                additionalSamplesNeededA: bestAdditionalA,
                additionalSamplesNeededB: bestAdditionalB,
                totalSamplesA: aTotal + bestAdditionalA,
                totalSamplesB: bTotal + bestAdditionalB,
                estimatedFinalWidth: bestWidth
            };
        }
        
        function toggleAdvanced() {
            const advancedInputs = document.getElementById('advanced-inputs');
            advancedInputs.classList.toggle('show');
        }
        
        async function runCalculation() {
            const button = document.querySelector('.calculate-btn');
            const resultsContent = document.getElementById('results-content');
            const sampleSizeSection = document.getElementById('sample-size-section');
            const sampleSizeContent = document.getElementById('sample-size-content');
            
            try {
                const aSuccesses = parseInt(document.getElementById('a-successes').value) || 0;
                const aTotal = parseInt(document.getElementById('a-total').value) || 1;
                const bSuccesses = parseInt(document.getElementById('b-successes').value) || 0;
                const bTotal = parseInt(document.getElementById('b-total').value) || 1;
                const nSimulations = parseInt(document.getElementById('n-simulations').value) || 100000;
                const alphaPrior = parseFloat(document.getElementById('alpha-prior').value) || 1;
                const betaPrior = parseFloat(document.getElementById('beta-prior').value) || 1;
                const targetWidth = parseFloat(document.getElementById('target-width').value) || 5.0;
                
                if (aSuccesses > aTotal || bSuccesses > bTotal) {
                    throw new Error('Successes cannot exceed total trials');
                }
                
                if (aTotal <= 0 || bTotal <= 0) {
                    throw new Error('Total trials must be greater than 0');
                }
                
                button.disabled = true;
                button.textContent = 'Calculating...';
                resultsContent.innerHTML = '<p class="loading">Running Bayesian simulation...</p>';
                sampleSizeSection.style.display = 'none';
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const results = runSimulation(aSuccesses, aTotal, bSuccesses, bTotal, nSimulations, alphaPrior, betaPrior);
                currentResults = {
                    ...results,
                    aSuccesses,
                    aTotal,
                    bSuccesses,
                    bTotal,
                    nSimulations,
                    alphaPrior,
                    betaPrior,
                    targetWidth,
                    timestamp: new Date().toISOString()
                };
                
                // Save last results
                try {
                    localStorage.setItem('abTestLastResults', JSON.stringify(currentResults));
                } catch (e) {
                    console.log('Could not save last results');
                }
                
                const upliftClass = results.meanUplift > 0 ? 'positive' : 'negative';
                const probClass = results.probBBetter > 0.5 ? 'positive' : 'negative';
                
                resultsContent.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-label">Conversion Rates</div>
                        <div class="metric-value metric-small">
                            A: ${(results.aConversion * 100).toFixed(2)}% | 
                            B: ${(results.bConversion * 100).toFixed(2)}%
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Estimated Relative Uplift</div>
                        <div class="metric-value ${upliftClass}">${results.meanUplift.toFixed(2)}%</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">95% Credible Interval</div>
                        <div class="metric-value metric-small">
                            [${results.ciLower.toFixed(2)}%, ${results.ciUpper.toFixed(2)}%]
                        </div>
                        <small>Width: ${results.ciWidth.toFixed(2)}%</small>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Probability B > A</div>
                        <div class="metric-value ${probClass}">${(results.probBBetter * 100).toFixed(1)}%</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Expected Loss</div>
                        <div class="metric-value metric-small">${results.expectedLoss.toFixed(4)}</div>
                    </div>
                `;
                
                const sampleSizeResults = calculateAdditionalSampleSize(aSuccesses, aTotal, bSuccesses, bTotal, targetWidth);
                
                sampleSizeContent.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-label">Additional Samples Needed</div>
                        <div class="metric-value metric-small">
                            A: +${sampleSizeResults.additionalSamplesNeededA} | 
                            B: +${sampleSizeResults.additionalSamplesNeededB}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Recommended Total Sample Size</div>
                        <div class="metric-value metric-small">
                            A: ${sampleSizeResults.totalSamplesA} | 
                            B: ${sampleSizeResults.totalSamplesB}
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-label">Estimated Final CI Width</div>
                        <div class="metric-value">${sampleSizeResults.estimatedFinalWidth.toFixed(2)}%</div>
                    </div>
                `;
                
                sampleSizeSection.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Run Bayesian Analysis';
            } catch (error) {
                resultsContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                button.disabled = false;
                button.textContent = 'Run Bayesian Analysis';
            }
        }
        
        function loadLastResults() {
            try {
                const lastResults = JSON.parse(localStorage.getItem('abTestLastResults') || 'null');
                if (lastResults) {
                    currentResults = lastResults;
                }
            } catch (e) {
                console.log('Could not load last results');
            }
        }
        
        function saveResult() {
            if (!currentResults) {
                alert('Please run a calculation first.');
                return;
            }
            
            const testName = document.getElementById('test-name').value || `Test ${new Date().toLocaleString()}`;
            
            const resultToSave = {
                ...currentResults,
                testName: testName
            };
            
            if (saveToStorage('abTestHistory', resultToSave)) {
                const saveButton = document.querySelector('.btn-success');
                const originalText = saveButton.textContent;
                saveButton.textContent = 'Saved!';
                saveButton.disabled = true;
                
                setTimeout(() => {
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                }, 2000);
                
                // Try to sync with Supabase
                syncHistoryToSupabase();
            } else {
                alert('Failed to save result. Storage not available.');
            }
        }
        
        async function loadHistory() {
            const historyContent = document.getElementById('history-content');
            
            // Try to fetch from Supabase first if available
            if (supabase) {
                try {
                    await fetchHistoryFromSupabase();
                } catch (error) {
                    console.log('Failed to fetch from Supabase, using local storage');
                }
            }
            
            const history = getFromStorage('abTestHistory');
            
            if (history.length === 0) {
                historyContent.innerHTML = '<p class="loading">No saved results yet. Run calculations and save them to build your test history.</p>';
                return;
            }
            
            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Date</th>
                            <th>A Conv.</th>
                            <th>B Conv.</th>
                            <th>Uplift</th>
                            <th>Prob. B > A</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            history.forEach((result, index) => {
                const upliftClass = result.meanUplift > 0 ? 'positive' : 'negative';
                const probClass = result.probBBetter > 0.5 ? 'positive' : 'negative';
                
                tableHTML += `
                    <tr>
                        <td>${result.testName || `Test ${index + 1}`}</td>
                        <td>${new Date(result.timestamp).toLocaleDateString()}</td>
                        <td>${(result.aConversion * 100).toFixed(2)}%</td>
                        <td>${(result.bConversion * 100).toFixed(2)}%</td>
                        <td class="${upliftClass}">${result.meanUplift.toFixed(2)}%</td>
                        <td class="${probClass}">${(result.probBBetter * 100).toFixed(1)}%</td>
                        <td>
                            <button class="delete-btn" onclick="deleteResult(${index})">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            historyContent.innerHTML = tableHTML;
        }
        
        function deleteResult(index) {
            const history = getFromStorage('abTestHistory');
            history.splice(index, 1);
            
            try {
                localStorage.setItem('abTestHistory', JSON.stringify(history));
                loadHistory();
                syncHistoryToSupabase();
            } catch (error) {
                console.error('Failed to delete result:', error);
                alert('Failed to delete result.');
            }
        }
        
        function clearHistory() {
            if (confirm('Are you sure you want to clear all test history? This cannot be undone.')) {
                if (clearStorage('abTestHistory')) {
                    loadHistory();
                    syncHistoryToSupabase();
                } else {
                    alert('Failed to clear history. Storage not available.');
                }
            }
        }
        
        function exportResults() {
            const history = getFromStorage('abTestHistory');
            
            if (history.length === 0) {
                alert('No results to export.');
                return;
            }
            
            let csvContent = "Test Name,Date,A Conversion,B Conversion,Mean Uplift,CI Lower,CI Upper,Probability B > A,Expected Loss\n";
            
            history.forEach(result => {
                csvContent += `"${result.testName || ''}",${new Date(result.timestamp).toLocaleDateString()},${result.aConversion},${result.bConversion},${result.meanUplift},${result.ciLower},${result.ciUpper},${result.probBBetter},${result.expectedLoss}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'ab_test_results.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function loadProgressTracking() {
            const selector = document.getElementById('test-selector');
            const history = getFromStorage('abTestHistory');
            
            // Clear existing options
            selector.innerHTML = '<option value="">Select a test...</option>';
            
            // Add options for each test
            history.forEach((result, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = result.testName || `Test ${index + 1}`;
                selector.appendChild(option);
            });
            
            // Clear chart if no test selected
            if (!progressChart) {
                const ctx = document.getElementById('progress-chart').getContext('2d');
                progressChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        }
        
        function updateProgressChart() {
            const selectedIndex = document.getElementById('test-selector').value;
            
            if (selectedIndex === '') {
                progressChart.data.labels = [];
                progressChart.data.datasets = [];
                progressChart.update();
                document.getElementById('progress-stats').innerHTML = '';
                return;
            }
            
            const history = getFromStorage('abTestHistory');
            const selectedTest = history[selectedIndex];
            
            // For demo purposes, we'll create some mock progress data
            // In a real implementation, this would come from actual test data over time
            const labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
            const data = [];
            const baseConversion = selectedTest.aConversion;
            const uplift = selectedTest.meanUplift / 100;
            
            // Generate mock data that converges toward the final result
            for (let i = 0; i < labels.length; i++) {
                const progress = (i + 1) / labels.length;
                const variation = (Math.random() - 0.5) * 0.02; // Â±1% variation
                data.push((baseConversion * (1 + uplift * progress) + variation) * 100);
            }
            
            progressChart.data.labels = labels;
            progressChart.data.datasets = [{
                label: 'Conversion Rate',
                data: data,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                fill: true,
                tension: 0.4
            }];
            
            progressChart.update();
            
            // Update stats
            const avgConversion = data.reduce((sum, val) => sum + val, 0) / data.length;
            const finalConversion = selectedTest.bConversion * 100;
            
            document.getElementById('progress-stats').innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Progress Summary</div>
                    <div class="metric-value metric-small">
                        Current: ${data[data.length - 1].toFixed(2)}% | 
                        Final: ${finalConversion.toFixed(2)}% | 
                        Average: ${avgConversion.toFixed(2)}%
                    </div>
                </div>
            `;
        }
        
        // Supabase functions
        function setupSupabase() {
            document.getElementById('supabase-setup').style.display = 'block';
            if (supabaseConfig) {
                document.getElementById('supabase-url').value = supabaseConfig.url || '';
            }
        }
        
        function saveSupabaseConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const anonKey = document.getElementById('supabase-anon-key').value.trim();
            
            if (!url || !anonKey) {
                alert('Please enter both Supabase URL and Anonymous Key');
                return;
            }
            
            supabaseConfig = {
                url: url,
                anonKey: anonKey
            };
            
            try {
                localStorage.setItem('abTestSupabaseConfig', JSON.stringify(supabaseConfig));
                document.getElementById('supabase-setup').style.display = 'none';
                document.getElementById('supabase-anon-key').value = ''; // Clear key field for security
                
                // Initialize Supabase client
                initializeSupabase();
                
                showSyncStatus('Supabase configuration saved successfully!', true);
            } catch (e) {
                showSyncStatus('Failed to save Supabase configuration', false);
            }
        }
        
        function loadSupabaseConfig() {
            try {
                supabaseConfig = JSON.parse(localStorage.getItem('abTestSupabaseConfig') || 'null');
                if (supabaseConfig) {
                    initializeSupabase();
                }
            } catch (e) {
                supabaseConfig = null;
            }
        }
        
        function initializeSupabase() {
            if (supabaseConfig) {
                supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
            }
        }
        
        async function syncWithSupabase() {
            if (!supabase) {
                alert('Please configure Supabase sync first');
                setupSupabase();
                return;
            }
            
            // First sync local changes to Supabase, then fetch any remote changes
            await syncHistoryToSupabase();
            await fetchHistoryFromSupabase();
        }
        
        async function syncHistoryToSupabase() {
            if (!supabase) return;
            
            try {
                const localHistory = getFromStorage('abTestHistory');
                
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    // Try to sign in anonymously
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        if (error.message.includes('Anonymous sign-ins are disabled')) {
                            showSyncStatus('Anonymous sign-ins are disabled in your Supabase project. Please enable them in your Supabase dashboard.', false);
                        } else {
                            showSyncStatus(`Failed to authenticate with Supabase: ${error.message}`, false);
                        }
                        return;
                    }
                }
                
                // Insert or update each history item
                const results = [];
                for (const item of localHistory) {
                    // Convert item to match Supabase schema
                    const supabaseItem = {
                        test_name: item.testName,
                        a_successes: item.aSuccesses,
                        a_total: item.aTotal,
                        b_successes: item.bSuccesses,
                        b_total: item.bTotal,
                        a_conversion_rate: item.aConversion,
                        b_conversion_rate: item.bConversion,
                        mean_uplift: item.meanUplift,
                        ci_lower: item.ciLower,
                        ci_upper: item.ciUpper,
                        ci_width: item.ciWidth,
                        prob_b_better: item.probBBetter,
                        expected_loss: item.expectedLoss,
                        n_simulations: item.nSimulations,
                        alpha_prior: item.alphaPrior,
                        beta_prior: item.betaPrior,
                        target_width: item.targetWidth
                    };
                    
                    // Try to insert, if it fails because of duplicate, update it
                    const { data, error } = await supabase
                        .from('ab_test_history')
                        .upsert(supabaseItem, {
                            onConflict: 'id',
                            returning: 'minimal'
                        });
                    
                    if (error) {
                        console.error('Error syncing item to Supabase:', error);
                        results.push({ success: false, error: error.message });
                    } else {
                        results.push({ success: true });
                    }
                }
                
                const successCount = results.filter(r => r.success).length;
                showSyncStatus(`Synced ${successCount} of ${localHistory.length} items to Supabase`, successCount > 0);
            } catch (error) {
                showSyncStatus(`Failed to sync to Supabase: ${error.message}`, false);
            }
        }
        
        async function fetchHistoryFromSupabase() {
            if (!supabase) return;
            
            try {
                // Get current user
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    // Try to sign in anonymously
                    const { data, error } = await supabase.auth.signInAnonymously();
                    if (error) {
                        if (error.message.includes('Anonymous sign-ins are disabled')) {
                            showSyncStatus('Anonymous sign-ins are disabled in your Supabase project. Please enable them in your Supabase dashboard.', false);
                        } else {
                            showSyncStatus(`Failed to authenticate with Supabase: ${error.message}`, false);
                        }
                        return;
                    }
                }
                
                // Fetch history from Supabase
                const { data, error } = await supabase
                    .from('ab_test_history')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    showSyncStatus(`Failed to fetch from Supabase: ${error.message}`, false);
                    return;
                }
                
                // Convert Supabase data back to local format
                const remoteHistory = data.map(item => ({
                    testName: item.test_name,
                    aSuccesses: item.a_successes,
                    aTotal: item.a_total,
                    bSuccesses: item.b_successes,
                    bTotal: item.b_total,
                    aConversion: item.a_conversion_rate,
                    bConversion: item.b_conversion_rate,
                    meanUplift: item.mean_uplift,
                    ciLower: item.ci_lower,
                    ciUpper: item.ci_upper,
                    ciWidth: item.ci_width,
                    probBBetter: item.prob_b_better,
                    expectedLoss: item.expected_loss,
                    nSimulations: item.n_simulations,
                    alphaPrior: item.alpha_prior,
                    betaPrior: item.beta_prior,
                    targetWidth: item.target_width,
                    timestamp: item.created_at
                }));
                
                const localHistory = getFromStorage('abTestHistory');
                
                // Merge histories (simple approach: take the longer one)
                // In a real app, you'd want a more sophisticated merge strategy
                if (remoteHistory.length > localHistory.length) {
                    localStorage.setItem('abTestHistory', JSON.stringify(remoteHistory));
                    loadHistory();
                    showSyncStatus('History updated from Supabase successfully!', true);
                } else {
                    showSyncStatus('History is up to date', true);
                }
            } catch (error) {
                showSyncStatus(`Failed to fetch from Supabase: ${error.message}`, false);
            }
        }
        
        // Cloud synchronization functions
        function showSyncStatus(message, isSuccess) {
            const statusDiv = document.getElementById('sync-status');
            statusDiv.textContent = message;
            statusDiv.className = 'sync-status ' + (isSuccess ? 'sync-success' : 'sync-error');
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
        
        // Add event listeners for tab buttons
        document.getElementById('calculator-tab').addEventListener('click', () => switchTab('calculator'));
        document.getElementById('history-tab').addEventListener('click', () => switchTab('history'));
        document.getElementById('progress-tab').addEventListener('click', () => switchTab('progress'));
        
        // Initialize the app
        loadLastInputData();
        loadLastResults();
        loadSupabaseConfig();
    </script>
</body>
</html>